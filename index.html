<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>simple_parallel</title>

    
    <link rel="stylesheet" href="rust.css">
<link rel="stylesheet" href="sliderust.css">
<script src="sliderust.js"></script>


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <h1 class="title">simple_parallel</h1>
    <p>Huon Wilson</p>

<p><br></p>

<p><img src="parallel.png" alt=""></p>

<p><a href="http://huonw.github.io/simple_parallel-jan16"><small>huonw.github.io/simple_parallel-jan16</small></a></p>

<p><a href="https://crates.io/crates/simple_parallel"><small>crates.io/crates/simple_parallel</small></a></p>

<h1 id='slooow-simple-for' class='section-header'><a href='#slooow-simple-for'>Slooow, Simple: <code>for</code></a></h1><pre class='rust rust-example-rendered'>
<span class='kw'>extern</span> <span class='kw'>crate</span> <span class='ident'>image</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>path</span>::<span class='ident'>Path</span>;

<span class='kw'>fn</span> <span class='ident'>resize_image</span>(<span class='ident'>path</span>: <span class='kw-2'>&amp;</span><span class='ident'>Path</span>) <span class='op'>-&gt;</span> <span class='ident'>image</span>::<span class='ident'>ImageResult</span><span class='op'>&lt;</span>()<span class='op'>&gt;</span> {
    <span class='comment'>// load the file as an image</span>
    <span class='kw'>let</span> <span class='ident'>img</span> <span class='op'>=</span> <span class='macro'>try</span><span class='macro'>!</span>(<span class='ident'>image</span>::<span class='ident'>open</span>(<span class='ident'>path</span>));

    <span class='comment'>// resize it</span>
    <span class='kw'>let</span> <span class='ident'>smaller</span> <span class='op'>=</span> <span class='ident'>img</span>.<span class='ident'>resize</span>(<span class='number'>400</span>, <span class='number'>400</span>, <span class='ident'>image</span>::<span class='ident'>Lanczos3</span>);

    <span class='comment'>// and save it with the same name in /tmp</span>
    <span class='kw'>let</span> <span class='ident'>output</span> <span class='op'>=</span> <span class='ident'>Path</span>::<span class='ident'>new</span>(<span class='string'>&quot;/tmp/&quot;</span>).<span class='ident'>join</span>(<span class='ident'>path</span>.<span class='ident'>file_name</span>().<span class='ident'>unwrap</span>());
    <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>f</span> <span class='op'>=</span> <span class='macro'>try</span><span class='macro'>!</span>(<span class='ident'>File</span>::<span class='ident'>create</span>(<span class='ident'>output</span>));
    <span class='ident'>smaller</span>.<span class='ident'>save</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>f</span>, <span class='ident'>image</span>::<span class='ident'>JPEG</span>)
}

<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='comment'>// command line arguments</span>
    <span class='kw'>let</span> <span class='ident'>files</span> <span class='op'>=</span> <span class='ident'>env</span>::<span class='ident'>args</span>().<span class='ident'>skip</span>(<span class='number'>1</span>);

    <span class='kw'>for</span> <span class='ident'>s</span> <span class='kw'>in</span> <span class='ident'>files</span> {
        <span class='kw'>match</span> <span class='ident'>resize_image</span>(<span class='ident'>s</span>.<span class='ident'>as_ref</span>()) {
            <span class='prelude-val'>Ok</span>(_) <span class='op'>=&gt;</span> {}
            <span class='prelude-val'>Err</span>(<span class='ident'>e</span>) <span class='op'>=&gt;</span> <span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;{}: error {:?}&quot;</span>, <span class='ident'>s</span>, <span class='ident'>e</span>)
        }
    }
}</pre>

<h1 id='slooow-simple-for-1' class='section-header'><a href='#slooow-simple-for-1'>Slooow, Simple: <code>for</code></a></h1><pre class='rust rust-example-rendered'>
<span class='kw'>let</span> <span class='ident'>files</span> <span class='op'>=</span> <span class='ident'>env</span>::<span class='ident'>args</span>().<span class='ident'>skip</span>(<span class='number'>1</span>);

<span class='kw'>for</span> <span class='ident'>s</span> <span class='kw'>in</span> <span class='ident'>files</span> {
    <span class='kw'>match</span> <span class='ident'>resize_image</span>(<span class='ident'>s</span>.<span class='ident'>as_ref</span>()) {
        <span class='prelude-val'>Ok</span>(_) <span class='op'>=&gt;</span> {}
        <span class='prelude-val'>Err</span>(<span class='ident'>e</span>) <span class='op'>=&gt;</span> <span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;{}: error {:?}&quot;</span>, <span class='ident'>s</span>, <span class='ident'>e</span>)
    }
}</pre>

<h1 id='fast-complicated-threading' class='section-header'><a href='#fast-complicated-threading'>Fast, Complicated: threading</a></h1><pre class='rust rust-example-rendered'>
<span class='kw'>extern</span> <span class='kw'>crate</span> <span class='ident'>scoped_threadpool</span>;

<span class='kw'>let</span> <span class='ident'>files</span> <span class='op'>=</span> <span class='ident'>env</span>::<span class='ident'>args</span>().<span class='ident'>skip</span>(<span class='number'>1</span>);

<span class='comment'>// set up the threads</span>
<span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>pool</span> <span class='op'>=</span> <span class='ident'>scoped_threadpool</span>::<span class='ident'>Pool</span>::<span class='ident'>new</span>(<span class='number'>4</span>);
<span class='ident'>pool</span>.<span class='ident'>scoped</span>(<span class='op'>|</span><span class='ident'>scope</span><span class='op'>|</span> {
    <span class='comment'>// run over the images</span>
    <span class='kw'>for</span> <span class='ident'>s</span> <span class='kw'>in</span> <span class='ident'>files</span> {
        <span class='comment'>// spawning a job for each one</span>
        <span class='ident'>scope</span>.<span class='ident'>execute</span>(<span class='kw'>move</span> <span class='op'>||</span> {
            <span class='kw'>match</span> <span class='ident'>resize_image</span>(<span class='ident'>s</span>.<span class='ident'>as_ref</span>()) {
                <span class='prelude-val'>Ok</span>(_) <span class='op'>=&gt;</span> {}
                <span class='prelude-val'>Err</span>(<span class='ident'>e</span>) <span class='op'>=&gt;</span> <span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;{}: error {:?}&quot;</span>, <span class='ident'>s</span>, <span class='ident'>e</span>)
            }
        })
    }
});</pre>

<h1 id='fast-simple-magic-threading' class='section-header'><a href='#fast-simple-magic-threading'>Fast, Simple: <em>magic</em> threading</a></h1><pre class='rust rust-example-rendered'>
<span class='kw'>extern</span> <span class='kw'>crate</span> <span class='ident'>simple_parallel</span>;

<span class='kw'>let</span> <span class='ident'>files</span> <span class='op'>=</span> <span class='ident'>env</span>::<span class='ident'>args</span>().<span class='ident'>skip</span>(<span class='number'>1</span>);

<span class='ident'>simple_parallel</span>::<span class='ident'>for_</span>(<span class='ident'>files</span>, <span class='op'>|</span><span class='ident'>s</span><span class='op'>|</span> {
    <span class='kw'>match</span> <span class='ident'>resize_image</span>(<span class='ident'>s</span>.<span class='ident'>as_ref</span>()) {
        <span class='prelude-val'>Ok</span>(_) <span class='op'>=&gt;</span> {}
        <span class='prelude-val'>Err</span>(<span class='ident'>e</span>) <span class='op'>=&gt;</span> <span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;{}: error {:?}&quot;</span>, <span class='ident'>s</span>, <span class='ident'>e</span>)
    }
})</pre>

<h1 id='how-does-it-work' class='section-header'><a href='#how-does-it-work'>How does it work?</a></h1><pre class='rust rust-example-rendered'>
<span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>for_</span><span class='op'>&lt;</span><span class='ident'>I</span>, <span class='ident'>F</span><span class='op'>&gt;</span>(<span class='ident'>iter</span>: <span class='ident'>I</span>, <span class='ident'>f</span>: <span class='ident'>F</span>)
    <span class='kw'>where</span> <span class='ident'>I</span>: <span class='ident'>IntoIterator</span>, <span class='comment'>// yields...</span>
          <span class='ident'>I</span>::<span class='ident'>Item</span>: <span class='ident'>Send</span> <span class='op'>+</span> <span class='ident'>Sync</span>, <span class='comment'>// which are passed to...</span>
          <span class='ident'>F</span>: <span class='ident'>Fn</span>(<span class='ident'>I</span>::<span class='ident'>Item</span>) <span class='op'>+</span> <span class='ident'>Sync</span></pre>

<p>TODO: diagram showing iterator &amp; some representation of parallelism</p>

<p>TODO: remove Sync when crossbeam loses it</p>

<h1 id='sharing' class='section-header'><a href='#sharing'>Sharing</a></h1>
<p>Safe:</p>
<pre class='rust rust-example-rendered'>
<span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>data</span> <span class='op'>=</span> [<span class='number'>0</span>; <span class='number'>10</span>];
<span class='kw'>let</span> <span class='ident'>outside</span> <span class='op'>=</span> <span class='number'>1</span>;

<span class='ident'>simple_parallel</span>::<span class='ident'>for_</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>data</span>, <span class='op'>|</span><span class='ident'>elem</span><span class='op'>|</span> <span class='op'>*</span><span class='ident'>elem</span> <span class='op'>+=</span> <span class='ident'>outside</span>);</pre>

<p><hr class="pause"></hr></p>

<p>Unsafe:</p>
<pre class='rust rust-example-rendered'>
<span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>data</span> <span class='op'>=</span> [<span class='number'>0</span>; <span class='number'>10</span>];
<span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>outside</span> <span class='op'>=</span> <span class='number'>0</span>;

<span class='ident'>simple_parallel</span>::<span class='ident'>for_</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>data</span>, <span class='op'>|</span><span class='ident'>elem</span><span class='op'>|</span> <span class='ident'>outside</span> <span class='op'>+=</span> <span class='op'>*</span><span class='ident'>elem</span>);</pre>

<p><hr class="pause"></hr></p>

<pre><code class="language-error">error: cannot assign to data in a captured outer variable in an `Fn` closure
     simple_parallel::for_(&amp;mut data, |elem| outside += *elem);
                                             ^~~~~~~~~~~~~~~~

</code></pre>

<h1 id='fast' class='section-header'><a href='#fast'>Fast?</a></h1>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>

<tbody>
<tr>
<td><code>for ... in</code></td>
<td>19.7s</td>
</tr>
<tr>
<td><code>simple_parallel::for_</code></td>
<td>5.5s</td>
</tr>
</tbody>
</table>

<p>3.6&times; faster.</p>

<h1 id='iterators-do-more-than-for' class='section-header'><a href='#iterators-do-more-than-for'>Iterators do more than <code>for</code></a></h1><pre class='rust rust-example-rendered'>
<span class='kw'>let</span> <span class='ident'>number_of_errors</span> <span class='op'>=</span>
    <span class='ident'>files</span>
        .<span class='ident'>map</span>(<span class='op'>|</span><span class='ident'>s</span><span class='op'>|</span> <span class='ident'>resize_image</span>(<span class='ident'>s</span>.<span class='ident'>as_ref</span>()
        .<span class='ident'>filter</span>(<span class='op'>|</span><span class='ident'>e</span><span class='op'>|</span> <span class='ident'>e</span>.<span class='ident'>is_err</span>())
        .<span class='ident'>count</span>();

<span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;{} errors occurred&quot;</span>, <span class='ident'>number_of_errors</span>);</pre>

<h1 id='simple_parallel-does-more-than-for' class='section-header'><a href='#simple_parallel-does-more-than-for'><code>simple_parallel</code> does more than <code>for</code>!</a></h1><pre class='rust rust-example-rendered'>
<span class='kw'>let</span> <span class='ident'>number_of_errors</span> <span class='op'>=</span> <span class='ident'>crossbeam</span>::<span class='ident'>scope</span>(<span class='op'>|</span><span class='ident'>scope</span><span class='op'>|</span> {

    <span class='ident'>simple_parallel</span>::<span class='ident'>map</span>(<span class='ident'>scope</span>,
            <span class='ident'>files</span>,
            <span class='op'>|</span><span class='ident'>s</span><span class='op'>|</span> <span class='ident'>resize_image</span>(<span class='ident'>s</span>.<span class='ident'>as_ref</span>()))
        .<span class='ident'>filter</span>(<span class='op'>|</span><span class='ident'>e</span><span class='op'>|</span> <span class='ident'>e</span>.<span class='ident'>is_err</span>())
        .<span class='ident'>count</span>()

});

<span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;{} errors occurred&quot;</span>, <span class='ident'>number_of_errors</span>);</pre>

<h1 id='ordering' class='section-header'><a href='#ordering'>Ordering?</a></h1>
<p>Some jobs finish faster than others: <code>unordered_map</code>.</p>
<pre class='rust rust-example-rendered'>
<span class='kw'>let</span> <span class='ident'>number_of_errors</span> <span class='op'>=</span> <span class='ident'>crossbeam</span>::<span class='ident'>scope</span>(<span class='op'>|</span><span class='ident'>scope</span><span class='op'>|</span> {

    <span class='ident'>simple_parallel</span>::<span class='ident'>unordered_map</span>(<span class='ident'>scope</span>,
            <span class='ident'>files</span>,
            <span class='op'>|</span><span class='ident'>s</span><span class='op'>|</span> <span class='ident'>resize_image</span>(<span class='ident'>s</span>.<span class='ident'>as_ref</span>()))
        .<span class='ident'>filter</span>(<span class='op'>|</span><span class='ident'>e</span><span class='op'>|</span> <span class='ident'>e</span>.<span class='number'>1</span>.<span class='ident'>is_err</span>())
        .<span class='ident'>count</span>()

});

<span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;{} errors occurred&quot;</span>, <span class='ident'>number_of_errors</span>);</pre>

<p>TODO benchmark of this &amp; <code>map</code>.</p>

<h1 id='todo-picture' class='section-header'><a href='#todo-picture'>TODO picture?</a></h1>
<p>(mirrored Good, Bad, Ugly poster)</p>

<h1 id='the-ugly' class='section-header'><a href='#the-ugly'>The Ugly</a></h1>
<ul>
<li>The internals</li>
<li>Panics in a job generally cascade to become an abort: need stable
<code>std::panic::recover</code> to be reliable.</li>
<li>To be generically useful, the <code>Iterator</code> is a black box</li>
</ul>

<h1 id='the-bad' class='section-header'><a href='#the-bad'>The Bad</a></h1>
<p>Inflexible: designed for flat, embarrassingly parallel jobs (unlike rayon).</p>

<p>TODO: comparison picture of flat vs. nested.</p>

<h1 id='the-good' class='section-header'><a href='#the-good'>The Good</a></h1>
<p>TODO: summary</p>

    <script type="text/javascript">
        window.playgroundUrl = "";
    </script>
    
</body>
</html>